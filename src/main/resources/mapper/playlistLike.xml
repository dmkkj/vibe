<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.PlaylistLikeMapper">
    
    <!-- 내가 좋아요한 플리 조회 -->
	<resultMap type="PlaylistLike" id="playlistLikeMap">
		<id column="like_code" property="likeCode" />
		<result column="like_date" property="likeDate" />
		<association property="user" javaType="User"> <!-- 테이블 생성 유저 -->
			<id column="user_email" property="userEmail" />
			<result column="user_nickname" property="userNickname" />
			<result column="user_img" property="userImg" />
		</association>
		<association property="playlist" javaType="Playlist">
			<id column="pl_code" property="plCode" />
			<result column="pl_title" property="plTitle" />
			<result column="pl_img" property="plImg" />
			<result column="pl_public_yn" property="plPublicYn" />
			<association property="user" javaType="User"> <!-- 접속중인 유저 -->
				<id column="user_email" property="userEmail" />
			</association>
		</association>
	</resultMap>

	<resultMap type="PlaylistLike" id="plLikeMap">
		<id property="likeCode" column="like_code"/>
		<result property="likeDate" column="like_date"/>
		<result property="plCode" column="pl_code"/>
		<result property="userEmail" column="user_email"/>
	</resultMap>

	<select id="likePlaylist" parameterType="String" resultMap="playlistLikeMap">
		SELECT l.like_code, l.like_date, c.user_email, c.user_nickname, c.user_img, p.pl_code, p.pl_title, p.pl_img
		FROM playlist_like l
			JOIN user m ON (m.user_email = l.user_email)
			JOIN playlist p using(pl_code)
			JOIN user c ON (p.user_email = c.user_email)
		WHERE pl_public_yn = 'Y'
			AND m.user_email = #{userEmail};
	</select>

	<!-- 좋아요 -->
	<select id="likeCheck" parameterType="PlaylistLike" resultMap="plLikeMap">
		SELECT * 
		FROM playlistLike
			JOIN user USING (user_email)
		WHERE pl_code = #{plCode}
			AND user_email = #{userEmail}
	</select>

	<!-- 좋아요 취소 -->
	<delete id="cancel" parameterType="Integer">
		DELETE FROM playlistLike
		WHERE like_code = #{likeCode}
	</delete>
	
	<!-- 좋아요 테이블에 유저이메일, 플레이리스트 추가 -->
	<insert id="like" parameterType="PlaylistLike" useGeneratedKeys="true" keyProperty="plCode">
		INSERT INTO playlistLike (user_email, pl_code)
		VALUES (#{userEmail}, #{plCode})
	</insert>
	
	<!-- 총 좋아요 수 -->
	<select id="count" parameterType="Integer" resultType="Integer">
		SELECT count(*)
		FROM playlistLike
		WHERE pl_code = #{plCode}
	</select>
</mapper>
